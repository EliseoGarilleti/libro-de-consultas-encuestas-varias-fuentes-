---
title: "Intenci√≥n de voto (IDV)"
format:
  html: default
  pdf: default
---

```{r, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, fig.path = "figures/")

# Asegurar idioma espa√±ol para los meses
locales <- c("es_ES.UTF-8", "Spanish_Spain.1252", "es_ES")
for (loc in locales) {
  res <- try(Sys.setlocale("LC_TIME", loc), silent = TRUE)
  if (!inherits(res, "try-error") && !is.na(res)) break
}
```

```{r, include=FALSE}
# Cargar entorno y configuraciones
source("code/00_setup.R")
source("code/01_theme.R")
source("code/02_datos.R")
```

```{r, include=FALSE}
df_idv<-df %>%
  group_by(mes, idv_group) %>%
  tally(wt = ponde_mes_ajustada) %>%
  mutate(perc = round((n / sum(n) * 100), 1)) %>%
  filter(idv_group %in% c("PSOE", "PP", "Vox", "Sumar", "Podemos")) 
```

```{r, echo=FALSE}
# ================================
#   GR√ÅFICO INTERACTIVO ggiraph
# ================================
p_idv <- ggplot(df_idv, aes(
  x = mes, y = perc, color = idv_group, group = idv_group
)) +
  # üîπ L√≠nea interactiva (responde al cursor en cualquier punto)
  geom_line_interactive(
    aes(
      tooltip = paste0(
        "<b>", idv_group, "</b><br>",
        format(mes, "%B %Y", locale = "es_ES.UTF-8"), ": ",
        perc, "%"
      )
    ),
    linewidth = .8
  ) +
  # üîπ Solo el √∫ltimo punto visible ‚Äî ahora s√≠ aislado
  geom_point_interactive(
    data = ultimo_por_grupo(df_idv, idv_group, mes),
    aes(
      x = mes,
      y = perc,
      color = idv_group,
      tooltip = paste0(
        "<b>", idv_group, "</b><br>",
        format(mes, "%B %Y", locale = "es_ES.UTF-8"), ": ",
        perc, "%"
      )
    ),
    size = 3,
    inherit.aes = FALSE
  ) +
  geom_hline(yintercept = 0, color = "black", linewidth = .2) +
  scale_x_date(labels = label_date("%b %y", locale = "es_ES")) +
  scale_color_manual(values = colores_partidos) +
  theme_minimal() +
  labs(
    subtitle = "Intenci√≥n de voto a 
      <span style='color:#E3001B'><b>PSOE</b></span>, 
      <span style='color:#1d4184'><b>PP</b></span>, 
      <span style='color:#5BC035'><b>Vox</b></span>, 
      <span style='color:#F57BA4'><b>Sumar</b></span> y 
      <span style='color:#662D91'><b>Podemos</b></span>"
  ) +
  theme_1

# --- Renderizado condicional ---
if (knitr::is_html_output()) {
  girafe(
    ggobj = p_idv,
    options = list(
      opts_hover(css = "stroke-width:3px;opacity:0.9;"),
      opts_tooltip(css = "background:white;color:black;padding:6px;
                            border-radius:6px;box-shadow:0px 1px 3px rgba(0,0,0,0.2);
                            font-family:Roboto;font-size:13px;"),
      opts_toolbar(saveaspng = TRUE)
    )
  )
} else {
  dir.create("figures", showWarnings = FALSE)
  static_plot_path <- file.path("figures", "p_idv_static.png")
  ggsave(static_plot_path, plot = p_idv, width = 8, height = 5, dpi = 300)
  Sys.sleep(1)
  knitr::include_graphics(static_plot_path)
}
```

```{r, echo=FALSE}
# ================================
#   RESUMEN AUTOM√ÅTICO
# ================================
resumen <- df_idv %>%
  group_by(idv_group) %>%
  summarise(
    mes_ini = min(mes, na.rm = TRUE),
    perc_ini = perc[which.min(mes)],
    mes_fin = max(mes, na.rm = TRUE),
    perc_fin = perc[which.max(mes)],
    mes_min = mes[which.min(perc)],
    perc_min = min(perc, na.rm = TRUE),
    mes_max = mes[which.max(perc)],
    perc_max = max(perc, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    diff = round(perc_fin - perc_ini, 1),
    color = case_when(
      idv_group == "PSOE" ~ "#E3001B",
      idv_group == "PP" ~ "#1d4184",
      idv_group == "Vox" ~ "#5BC035",
      idv_group == "Sumar" ~ "#F57BA4",
      idv_group == "Podemos" ~ "#662D91"
    ),
    texto = glue(
      "<li><b><span style='color:{color}'>{idv_group}</span></b>: ",
      "En {format(mes_ini, '%B de %Y', locale='es_ES.UTF-8')} un {perc_ini}% afirmaba que les votar√≠a, ",
      "hoy lo hace un {perc_fin}%, una diferencia de {diff} puntos. ",
      "El dato m√°s bajo fue {perc_min}% en {format(mes_min, '%B de %Y', locale='es_ES.UTF-8')}, ",
      "y el m√°s alto {perc_max}% en {format(mes_max, '%B de %Y', locale='es_ES.UTF-8')}.</li>"
    )
  )
```

```{r, results='asis', echo=FALSE}
cat("<br>")
cat("<ul>")
cat(paste(resumen$texto, collapse = "\n"))
cat("</ul>")
```
